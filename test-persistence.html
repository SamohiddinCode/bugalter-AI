<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест сохранения данных</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Тест сохранения данных</h1>
        
        <div class="test-section">
            <h3>Добавить транзакцию</h3>
            <form id="add-transaction-form">
                <div class="form-group">
                    <label>Описание</label>
                    <input type="text" id="description" value="Тестовая транзакция" required>
                </div>
                <div class="form-group">
                    <label>Сумма</label>
                    <input type="number" id="amount" value="1000" required>
                </div>
                <div class="form-group">
                    <label>Тип</label>
                    <select id="type" required>
                        <option value="income">Доход</option>
                        <option value="expense">Расход</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Категория</label>
                    <input type="text" id="category" value="Тест">
                </div>
                <div class="form-group">
                    <label>Источник</label>
                    <input type="text" id="source" value="Тест">
                </div>
                <div class="form-group">
                    <label>Дата</label>
                    <input type="date" id="date" required>
                </div>
                <button type="submit" class="btn btn-primary">Добавить транзакцию</button>
            </form>
        </div>
        
        <div class="test-section">
            <h3>Действия</h3>
            <button class="btn btn-success" onclick="checkData()">Проверить данные</button>
            <button class="btn btn-warning" onclick="clearData()">Очистить данные</button>
            <button class="btn btn-danger" onclick="simulateProblem()">Симулировать проблему</button>
        </div>
        
        <div class="test-section">
            <h3>Текущие данные в localStorage</h3>
            <div id="data-display" class="data-display">Нет данных</div>
        </div>
        
        <div class="test-section">
            <h3>Лог операций</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // Устанавливаем текущую дату
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        // Простая функция логирования
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Проверить данные
        function checkData() {
            const dataDisplay = document.getElementById('data-display');
            const allData = {};
            
            // Получить все данные из localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                try {
                    allData[key] = JSON.parse(value);
                } catch {
                    allData[key] = value;
                }
            }
            
            dataDisplay.textContent = JSON.stringify(allData, null, 2);
            log(`Проверка данных: найдено ${Object.keys(allData).length} ключей`);
            
            // Проверить транзакции отдельно
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            log(`Транзакций в localStorage: ${transactions.length}`);
            if (transactions.length > 0) {
                log(`Последняя транзакция: ${JSON.stringify(transactions[transactions.length - 1])}`);
            }
        }

        // Очистить данные
        function clearData() {
            localStorage.removeItem('transactions');
            log('Данные очищены');
            checkData();
        }

        // Симулировать проблему
        function simulateProblem() {
            log('=== СИМУЛЯЦИЯ ПРОБЛЕМЫ ===');
            
            // Получить текущие транзакции
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            log(`Транзакций до симуляции: ${transactions.length}`);
            
            // Попробовать разные способы сохранения
            const testTransaction = {
                id: Date.now(),
                description: "Тестовая транзакция",
                amount: 1000,
                type: "income",
                category: "Тест",
                source: "Тест",
                date: new Date().toISOString().split('T')[0],
                comment: "Тестовый комментарий",
                createdAt: new Date().toISOString()
            };
            
            // Способ 1: Прямое добавление в массив
            const newTransactions1 = [...transactions, testTransaction];
            localStorage.setItem('transactions', JSON.stringify(newTransactions1));
            log(`Способ 1: ${newTransactions1.length} транзакций`);
            
            // Проверить результат
            const check1 = JSON.parse(localStorage.getItem('transactions') || '[]');
            log(`Проверка 1: ${check1.length} транзакций`);
            
            // Способ 2: Через push
            const transactions2 = JSON.parse(localStorage.getItem('transactions') || '[]');
            transactions2.push({
                ...testTransaction,
                id: Date.now() + 1
            });
            localStorage.setItem('transactions', JSON.stringify(transactions2));
            log(`Способ 2: ${transactions2.length} транзакций`);
            
            // Проверить результат
            const check2 = JSON.parse(localStorage.getItem('transactions') || '[]');
            log(`Проверка 2: ${check2.length} транзакций`);
            
            log('=== СИМУЛЯЦИЯ ЗАВЕРШЕНА ===');
            checkData();
        }

        // Обработчик формы
        document.getElementById('add-transaction-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                type: document.getElementById('type').value,
                category: document.getElementById('category').value,
                source: document.getElementById('source').value,
                date: document.getElementById('date').value,
                comment: 'Добавлено через тест'
            };
            
            log('=== ДОБАВЛЕНИЕ ТРАНЗАКЦИИ ===');
            log(`Входные данные: ${JSON.stringify(formData)}`);
            
            try {
                // Получить существующие транзакции
                const existingTransactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                log(`Существующих транзакций: ${existingTransactions.length}`);
                
                // Создать новую транзакцию
                const newTransaction = {
                    id: Date.now() + Math.random(),
                    description: formData.description,
                    amount: formData.type === 'expense' ? -Math.abs(formData.amount) : Math.abs(formData.amount),
                    type: formData.type,
                    category: formData.category,
                    source: formData.source,
                    date: formData.date,
                    comment: formData.comment,
                    createdAt: new Date().toISOString()
                };
                
                log(`Создана транзакция: ${JSON.stringify(newTransaction)}`);
                
                // Добавить к существующим
                const updatedTransactions = [...existingTransactions, newTransaction];
                log(`Всего транзакций после добавления: ${updatedTransactions.length}`);
                
                // Сохранить в localStorage
                localStorage.setItem('transactions', JSON.stringify(updatedTransactions));
                log('Транзакция сохранена в localStorage');
                
                // Проверить сохранение
                const checkTransactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                log(`Проверка сохранения: ${checkTransactions.length} транзакций`);
                
                log('=== ТРАНЗАКЦИЯ УСПЕШНО ДОБАВЛЕНА ===');
                
                // Очистить форму
                this.reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                
                // Обновить отображение
                checkData();
                
            } catch (error) {
                log(`ОШИБКА при добавлении транзакции: ${error.message}`);
            }
        });

        // Инициализация
        checkData();
        log('Страница загружена');
    </script>
</body>
</html> 