<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест баланса</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .btn.active { background: #0056b3; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Тест отображения баланса</h1>
        
        <div class="test-section">
            <h3>Добавить тестовые транзакции</h3>
            <button class="btn btn-primary" onclick="addTestTransactions()">Добавить тестовые данные</button>
            <button class="btn btn-success" onclick="clearTransactions()">Очистить все транзакции</button>
        </div>
        
        <div class="test-section">
            <h3>Выбор периода</h3>
            <button class="btn btn-primary" data-period="today">Сегодня</button>
            <button class="btn btn-primary" data-period="week">Неделя</button>
            <button class="btn btn-primary active" data-period="month">Месяц</button>
            <button class="btn btn-primary" data-period="year">Год</button>
        </div>
        
        <div class="test-section">
            <h3>Статистика</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="current-balance">0 UZS</div>
                    <div class="stat-label">Общий баланс</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-income">0 UZS</div>
                    <div class="stat-label">Доходы (период)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-expense">0 UZS</div>
                    <div class="stat-label">Расходы (период)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="budget-used">0%</div>
                    <div class="stat-label">Бюджет использован</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Лог операций</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        // Простая функция логирования
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Добавить тестовые транзакции
        function addTestTransactions() {
            const testTransactions = [
                {
                    id: Date.now(),
                    description: "Зарплата",
                    amount: 5000000,
                    type: "income",
                    category: "Зарплата",
                    source: "Работа",
                    date: "2025-08-06",
                    comment: "Зарплата за август",
                    createdAt: new Date().toISOString()
                },
                {
                    id: Date.now() + 1,
                    description: "Продукты",
                    amount: 250000,
                    type: "expense",
                    category: "Продукты",
                    source: "Магазин",
                    date: "2025-08-06",
                    comment: "Покупка продуктов",
                    createdAt: new Date().toISOString()
                },
                {
                    id: Date.now() + 2,
                    description: "Бонус",
                    amount: 1000000,
                    type: "income",
                    category: "Бонус",
                    source: "Работа",
                    date: "2025-08-05",
                    comment: "Премия",
                    createdAt: new Date().toISOString()
                },
                {
                    id: Date.now() + 3,
                    description: "Такси",
                    amount: 50000,
                    type: "expense",
                    category: "Транспорт",
                    source: "Такси",
                    date: "2025-08-05",
                    comment: "Поездка на работу",
                    createdAt: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('transactions', JSON.stringify(testTransactions));
            log('Добавлены тестовые транзакции');
            updateStats();
        }

        // Очистить все транзакции
        function clearTransactions() {
            localStorage.removeItem('transactions');
            log('Все транзакции удалены');
            updateStats();
        }

        // Обновить статистику
        function updateStats() {
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            
            // Получить текущий период
            const activePeriodButton = document.querySelector('[data-period].active');
            const currentPeriod = activePeriodButton ? activePeriodButton.dataset.period : 'month';
            
            // Фильтровать транзакции по периоду
            const filteredTransactions = filterTransactionsByPeriod(transactions, currentPeriod);
            
            // Рассчитать доходы и расходы за период
            const periodIncome = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                
            const periodExpense = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            // Рассчитать общий баланс (за все время)
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
                
            const totalBalance = totalIncome - totalExpense;
            const budgetUsed = periodIncome > 0 ? Math.round((periodExpense / periodIncome) * 100) : 0;

            // Обновить отображение
            document.getElementById('current-balance').textContent = `${totalBalance.toLocaleString()} UZS`;
            document.getElementById('total-income').textContent = `${periodIncome.toLocaleString()} UZS`;
            document.getElementById('total-expense').textContent = `${periodExpense.toLocaleString()} UZS`;
            document.getElementById('budget-used').textContent = `${budgetUsed}%`;

            log(`Обновление статистики:`);
            log(`- Общий баланс (все время): ${totalBalance.toLocaleString()} UZS`);
            log(`- Доходы за ${currentPeriod}: ${periodIncome.toLocaleString()} UZS`);
            log(`- Расходы за ${currentPeriod}: ${periodExpense.toLocaleString()} UZS`);
        }

        // Фильтровать транзакции по периоду
        function filterTransactionsByPeriod(transactions, period) {
            const now = new Date();
            let startDate, endDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                    endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + 6, 23, 59, 59);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                    break;
                default:
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            }

            return transactions.filter(transaction => {
                let transactionDate;
                if (typeof transaction.date === 'string') {
                    transactionDate = new Date(transaction.date + 'T00:00:00');
                } else {
                    transactionDate = new Date(transaction.date);
                }
                
                if (isNaN(transactionDate.getTime())) {
                    return false;
                }
                
                return transactionDate >= startDate && transactionDate <= endDate;
            });
        }

        // Обработчик изменения периода
        function handlePeriodChange(period) {
            log(`Переключение периода на: ${period}`);
            
            // Обновить активную кнопку
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');

            // Обновить статистику
            updateStats();
            
            log(`Период ${period} успешно применен`);
        }

        // Привязать обработчики событий
        document.querySelectorAll('[data-period]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                handlePeriodChange(e.target.dataset.period);
            });
        });

        // Инициализация
        updateStats();
        log('Страница загружена');
    </script>
</body>
</html> 